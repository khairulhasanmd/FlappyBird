<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="A single-page template generated by Tizen Web IDE"/>

    <title>Tizen Web IDE - Tizen - jQuery Mobile - Single-Page</title>

    <!--<link rel="stylesheet" href="./css/jquery.mobile-1.3.2.css"/>-->
    <script type="text/javascript" src="./js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="./js/jquery.mobile-1.3.2.js"></script>
   <!--   <script type="text/javascript" src="./js/main.js"></script>-->
   <!--  <link rel="stylesheet" href="./css/style.css" /> -->
    <script type='text/javascript'>
$(document).ready(function () {
/*
Modes to implement:
1. Practice(play to improve your skills)
	percentage = skill medal
2. Arcade
	1st level = 50 life and 500 pipes(gap is bigger) fps varies
	2nd level = 25 life and 250 pipes(gap is normal)fps varies
	3rd level = 5  life and unlimited pipes(gap is small) fps varies
	succeded pipe count=medal
	percentage=skill medal
3. Survival(The Hardest)
	1. life 1 gap small(Single Life) 30 fps
	2. life 5 gap is freaky and big(Freaky Pipes) 30 fps
4. Multiplayer(how the hell could be implemented?)
*/

  //touch events handler
    window.addEventListener("touchstart", touchStartHandler, false);
    window.addEventListener("touchend", touchEndHandler, false);
    window.addEventListener("touchmove", touchMoveHandler, false);
    
    
    
    //add eventListener for tizenhwkey
    window.addEventListener('tizenhwkey', function(e) {
        if(e.keyName == "back")
            tizen.application.getCurrentApplication().exit();
    });


	var c=document.getElementById("GameCanvas");
	var isMoved=false;
	var Game=c.getContext("2d");
	Game.font="12px Georgia";           
	var CANVAS_WIDTH = c.width;
	var CANVAS_HEIGHT = c.height;
	var imgBird = new Image();
	imgBird.src = 'img/bird.png';
	var imgBg = new Image();
	imgBg.src = 'img/img-bg.png';
	var imgGround = new Image();
	imgGround.src = 'img/ground.png';
	var imgPipe = new Image();
	imgPipe.src = 'img/pipes.png';
	var imgBigNumbers = new Image();
	imgBigNumbers.src = 'img/bignumbers.png';
	var imgSmallNumbers = new Image();
	imgSmallNumbers.src = 'img/smallnumbers.png';
	var imgLife = new Image();
	imgLife.src = 'img/life.png';
	var imgGameOver = new Image();
	imgGameOver.src = 'img/gameover.png';
	var FPS=30;
	var gravity=0;
	var PipeDistance=200;
	var gap=140;
	var died=0;
	var alive=0;
	var point=0;
	var Life=5;
	var Difficulty=10;
	var FreakyPipe=false
	var GameActive=true;

	var ThisGame;
	ThisGame=setInterval(function() {
		checkKeys();
		draw();

	}, 1000/FPS);
		
	function draw()
	{
	if (GameActive==true){
			Game.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
			bg.draw();
			
			pipes = pipes.filter(function(pipe) {
				return pipe.active;
			});
			pipes.forEach(function(pipe) {
				if (pipe.id==2)
				{
					if(gapMissed(player, pipe)) {  
						died++;
						pipe.id=0;
					}
				}
				pipe.update();
				pipe.draw();
			});
			ground.draw();
			player.animate();
			
			if(pipes[pipes.length-1]){
				if(pipes[pipes.length-1].x<(CANVAS_WIDTH-PipeDistance)){
					pipes.push(Pipe());  
					if (pipes[1].id==2)
					{
						alive++; 
					}
				}
			}
			point=alive-died;
			Game.fillStyle = "black";				
			//Game.fillText("y["+player.y+"]  Y["+player.newY+"]  G["+gravity+"]  ID["+player.id+"]  Gp["+(pipes[pipes.length-1].gapCenter-(gap/2))+","+(pipes[pipes.length-1].gapCenter+(gap/2))+"]  Died["+died+"]",3 ,14);
			Score(point,died);
			if (Life<=0)
			{
				GameActive=false;
				life=0;
				ShowLife(Life);
			}
			else
			{
				ShowLife(Life);
				Life=5-Math.floor(died/Difficulty);
			}
		}//--------------------
		else
		{
			Game.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
			bg.draw();
			ground.draw();
			Game.drawImage(imgGameOver, (CANVAS_WIDTH-192)/2, (CANVAS_HEIGHT-44)/2);
			//clearInterval(ThisGame);
			showControls();
		}
	}
	
	//-------------------------------Touch Actions-------------------------
function touchStartHandler(e) {
    var pTarget = e.touches.item(0);
if (GameActive==true)
	{
		if (player.newY>50){
			player.newY=player.y-50; 
			player.id=2;	
			player.degrees=-30;	
			}
			         //e.preventDefault();
	}
	else
	{
	
	}

}

function touchMoveHandler(e) {
var pTarget = e.touches.item(0);
    //isMoved = true;
   if (GameActive==true)
	{
		if (player.newY>50){
			player.newY=player.y-50; 
			player.id=2;	
			player.degrees=-30;	
			}
	}
         e.preventDefault();
}
function touchEndHandler() {

    ///if(!isMoved){
  ///
    ///}
    //isMoved=false;
    //drawPath.length = 0; //Initialize the stored coordinates
}
	//---------------------------------------------Keyboard 
	var keys = [];

	$(document).keydown(function (e) {
		keys[e.keyCode] = true;
		//console.log(e.keyCode);
	});
	$(document).keyup(function (e) {
		delete keys[e.keyCode];
	});

	function checkKeys(){
	if (GameActive==true)
	{
		if(keys[32])//Space
		{
		if (player.newY>50){
			player.newY=player.y-50; 
			player.id=2;	
			player.degrees=-30;	
			}
		}
	}
}

	var player = {
		  id: 0,
          width: 34,//
          height: 24,
		  x: 70,//middle position
		  newY:270,
          y: 270,//maybe canvas height - player spaceship height
		  degrees:0,
		  animate: function() 
		  {
		    if (player.y>=0 && player.y<(CANVAS_HEIGHT-ground.height))
			{
				if (player.y>player.newY)
				{
					if (player.degrees<=90)
					{
						player.degrees=player.degrees+7;
					}
					gravity=0;
					if (player.y>(player.newY+4))
					{
						player.y=player.y+Math.floor((player.newY-player.y)/4)
						player.id=2;
					}
					else
					{ 
						player.y--;
						player.id=1;
					}
				}
				else if (player.y<=player.newY)
				{
					if (player.y<((CANVAS_HEIGHT-ground.height)-(player.height))){
					gravity=gravity+2;
					player.y=player.y+gravity;
					player.newY=player.y;  
					player.id=0;
					}
					else
					{
						player.degrees=0;
						player.id=1;
						player.y=(CANVAS_HEIGHT-ground.height)-player.height/2;
						player.newY=player.y;  
					}					
				}
			}
			else//if outside canvas
			{
				player.degrees=0;
				player.id=1;
				player.y=(CANVAS_HEIGHT-ground.height)-player.height/2;
				player.newY=player.y; 
			}
			this.drawRotated();
		  },
          draw: function() {
			Game.drawImage(imgBird, this.id*this.width, 0, this.width, this.height, this.x, this.y, this.width, this.height);
		  },
		  drawRotated: function (){
			Game.save();
			Game.translate(player.x,player.y);
			Game.rotate(this.degrees*Math.PI/180);
			Game.drawImage(imgBird, player.id*player.width, 0, player.width, player.height, -player.width/2, -player.height/2, player.width, player.height);
			Game.restore();
		   }
    };
	var bg = {
		  id: 0,//0=day, 1=night
		  positionX: 0, 
          width: 288,//
          height: 511,
		  i: 0,
          draw: function() {
			this.positionX--;
			if (this.positionX<(-this.width))
			{
				this.positionX=0;
			}
			while (this.positionX+(this.width*this.i)<CANVAS_WIDTH)
			{
				Game.drawImage(imgBg, this.id*this.width, 0, this.width, this.height, this.positionX+(this.width*this.i), 0, this.width, this.height);
				this.i++;
			}
			this.i=0;
		  }
    };
	var ground = {
		  positionX: 0,
          width: 336,//
          height: 83,
		  y: 100,
		  i: 0,
          draw: function() {
			this.positionX=this.positionX-3;
			if (this.positionX<(-this.width))
			{
				this.positionX=0;
			}
			while (this.positionX+(this.width*this.i)<CANVAS_WIDTH)
			{
				Game.drawImage(imgGround, 0, 0, this.width, this.height, this.positionX+(this.width*this.i), this.y, this.width, this.height);
				this.i++;
			}
			this.i=0;
		  }
    };
	
	function Score(passed,failed)
	{
		
			var i=0;
			var y=50;
			var digits1 = passed.toString().split('');
			var digits2 = failed.toString().split('');
			var width=((digits1.length*26)+4+(digits2.length*15));
			var lastloc=Math.floor((CANVAS_WIDTH-width)/2);
			for (i=0; i<digits1.length; i++) 
			{
			
                Game.drawImage(imgBigNumbers, digits1[i]*24, 0, 24, 36, lastloc+(i*26), y, 24, 36);
			}
			lastloc=Math.floor((CANVAS_WIDTH-width)/2)+((i)*26);
			for (i=0; i<digits2.length; i++) 
			{
				Game.drawImage(imgSmallNumbers, digits2[i]*14, 0, 14, 20, lastloc+(i*15), y, 14, 20); 
			}
	}
	function ShowLife(lid){
		lid=5-lid;
		var lwidth= 63;
		var lheight= 63;
		var lx= Math.floor((CANVAS_WIDTH-32)/2);
		var ly= 10;
		Game.drawImage(imgLife, 0, lid*lheight, lwidth, lheight, lx, ly, 32, 32);
	}
/* 
img		Specifies the image, canvas, or video element to use	 
sx		Optional. The x coordinate where to start clipping	
sy		Optional. The y coordinate where to start clipping	
swidth	Optional. The width of the clipped image	
sheight	Optional. The height of the clipped image	
x		The x coordinate where to place the image on the canvas	
y		The y coordinate where to place the image on the canvas	
width	Optional. The width of the image to use 
			(stretch or reduce the image)	
height	Optional. The height of the image to use 
			(stretch or reduce the image)   */
		var pipes = [];//an array that will hold the bullets
        function Pipe(I) {
		  I = I || {};
		  I.id = 2;
		  I.age = Math.random()*90;
		  I.x = CANVAS_WIDTH-1;
          I.active = true;
		  I.xVelocity = 3;
          I.yVelocity = 0;
          I.width = 52;
          I.height = 880;
		  I.gapCenter = randomNumberBetween(120,(CANVAS_HEIGHT-(ground.height+(gap+100))));
          I.inBounds = function() {
            return I.x >= -I.width && I.x <= CANVAS_WIDTH ;
          };
        
          I.draw = function() {
            Game.drawImage(imgPipe, (I.id*I.width), 0, I.width, I.height, I.x, I.gapCenter-((gap/2)+I.height), I.width, I.height);
			Game.drawImage(imgPipe, ((I.id+1)*I.width), 0, I.width, I.height, I.x, I.gapCenter+(gap/2), I.width, I.height);
          };
          
          I.update = function() {
			I.x -= I.xVelocity;
			if (FreakyPipe==true){
				I.yVelocity = 2* Math.sin(I.age * Math.PI / 64);
				I.age++;
				I.gapCenter = Math.floor(I.gapCenter+I.yVelocity);
			}
            I.active = I.active && I.inBounds();
          };
        
          I.explode = function() {
            this.active = false;
          };
        
          return I;
        }
		
	function randomNumberBetween(from, to) {
		return Math.floor((Math.random()*to)+from);
	}
	
	function init()
	{
		GameActive=false;
		ground.y=CANVAS_HEIGHT-ground.height;
	}
	$("input[name='practice']").click(function() {
	if (GameActive==false){
		gravity=0;
		PipeDistance=200;
		gap=160;
		died=0;
		alive=0;
		point=0;
		Life=5;
		Difficulty=1000;
		FreakyPipe=false
		GameActive=true;
		pipes.forEach(function(pipe) {
			pipe.active=false;
		});
		pipes.push(Pipe());
		hideControls();
	}
	});
	$("input[name='arcade']").click(function() {
	if (GameActive==false){
		gravity=0;
		PipeDistance=200;
		gap=140;
		died=0;
		alive=0;
		point=0;
		Life=5;
		Difficulty=10;
		FreakyPipe=false
		GameActive=true;
		pipes.forEach(function(pipe) {
			pipe.active=false;
		});
		pipes.push(Pipe());
		hideControls();
	}
	});
    $("input[name='survival']").click(function() {
		if (GameActive==false){
		gravity=0;
		PipeDistance=200;
		gap=140;
		died=0;
		alive=0;
		point=0;
		Life=5;
		Difficulty=1;
		FreakyPipe=false
		GameActive=true;
		pipes.forEach(function(pipe) {
			pipe.active=false;
		});
		pipes.push(Pipe());
		hideControls();
	}
	});
	$("input[name='extreme']").click(function() {
		if (GameActive==false){
		gravity=0;
		PipeDistance=200;
		gap=140;
		died=0;
		alive=0;
		point=0;
		Life=5;
		Difficulty=1;
		FreakyPipe=true
		GameActive=true;
		pipes.forEach(function(pipe) {
			pipe.active=false;
		});
		pipes.push(Pipe());
		hideControls();
	}
	});
	
	function hideControls()
	{
		 document.getElementById('practice').style.visibility='hidden'; // hide 
		 document.getElementById('arcade').style.visibility='hidden'; // hide 
		 document.getElementById('survival').style.visibility='hidden'; // hide 
		 document.getElementById('extreme').style.visibility='hidden'; // hide 
	}
	function showControls()
	{
		 document.getElementById('practice').style.visibility='visible'; // hide 
		 document.getElementById('arcade').style.visibility='visible'; // hide 
		 document.getElementById('survival').style.visibility='visible'; // hide 
		 document.getElementById('extreme').style.visibility='visible'; // hide 
	}
	
	/*function collides(a, b) {
	document.title = "a"+ a.x+","+a.y+" b"+b.x+","+b.y;
          return b.x > a.x && b.x < a.x + a.width &&
				 b.y > a.y && b.y < a.y + a.height &&
				 a.x > b.x && a.x < b.x + b.width &&
				 a.y > b.y && a.y < b.y + b.height;
	}*/
	function gapMissed(a, b) {
		if (a.x+(a.width-10) > b.x && a.x < b.x + b.width)
		{
			if (a.y < b.gapCenter - gap/2)
			{
				return 1;
			}
			else if (a.y + a.height > b.gapCenter + gap/2)
			{
				return 1;
			}
		}
		else
		{
			return 0;
		}
	}
	init();
});

</script>
</head>

<body>
    <div data-role="page" >
    	<canvas id="GameCanvas" width="343" height="593" style="border:1px solid #d3d3d3; z-index:1;">
		</canvas>
		<input type="button" name="practice" id="practice" style="z-index:2; position:absolute; top:120px; left:140px; visibility:visible" value="Practice"/>
		<input type="button" name="arcade" id="arcade" style="z-index:2; position:absolute; top:150px; left:140px; visibility:visible" value="Arcade"/>
		<input type="button" name="survival" id="survival" style="z-index:2; position:absolute; top:180px; left:140px; visibility:visible" value="Survival"/>
		<input type="button" name="extreme" id="extreme" style="z-index:2; position:absolute; top:210px; left:140px; visibility:visible" value="Extreme"/>
         </div>
</body>
</html>